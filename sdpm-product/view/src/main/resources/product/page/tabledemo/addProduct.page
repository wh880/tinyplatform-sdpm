#*
#!set(linkName="product-demand",sonitem="<li>"+"需求"+"</li>")
*#
#set(pltype="addProduct")

#import("/org/tinygroup/button/components/button_common.component")
#import("/org/tinygroup/button/components/button.component")

#@tinyForm("thisform" TINY_CONTEXT_PATH +adminPath+"/product/save" "post" {"class":""})
<div style="width:100%;float:center" class="pageleftpart">
<div class="infoContent">
    <p class="titleName">添加产品</p>

    #@elementItem()
        #@colLabel()<span class="c-red">*</span>产品线名称：#end
        #@formControlDiv("col-3")
            #@Tselect2F()
                <script>
                    $(function () {
                        #if(!cookieProductLineId)
                            var productLineId = $("#productLineNameOnTop").attr("value");
                            if (productLineId > 0) {
                                $("select[name=productLineId]").val(productLineId).trigger("change");
                            }
                        #end
                        $("select[name=productLineId]").on("change", function () {
                            $("input[name=productName]").blur();
                            $("input[name=productCode]").blur();
                        });
                    })
                </script>
                #@Tselect2Body("productLineId" cookieProductLineId {"class":"input-text select2"})
                    #for(productLine : ProductUtils.getProductLineList())
                    <option value="${productLine?.productLineId}">${productLine?.productLineName}</option>
                #end
            #end

            #@Tselect2Fix()
                #set(m=menuManager.getMenu("productLine-add"))
                #if(m)
                    <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}" class="r">增加</a>
                #end
                #set(m=menuManager.getMenu("productLine-view-all"))
                #if(m)
                    <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}">全部</a>
                #end
            #end


        #end

    #end
    #@validateDiv("col-2")#end
#end



#@elementItem()
    #@colLabel()<span class="c-red">*</span>产品名称：#end
    #@formControlDiv("col-3")
        #tinyInput(
            "text" "productName" ""{"placeholder":"请输入产品名称","datatype":"*","nullmsg":"产品名称不能为空！","id":
            "productName","class":"input-text"})
        <script>

            $("input[name=productName]").on("blur", function () {
                var pName = $(this).val();
                if (pName) {
                    var plId = $("select[name=productLineId] option:selected").val();
                    if (plId > 0) {
                        $.ajax({
                            url: "${TINY_CONTEXT_PATH+adminPath}/product/judgeProductName",
                            type: "POST",
                            data: {productName: pName, productLineId: plId},
                            success: function (data) {
                                if (data.status == "y") {
                                    $("input[name=productName]").addClass("Validform_error");
                                    $("input[name=productName]").parent().parent().find("div[class=col-2]").html("<span class='Validform_checktip Validform_wrong'>该产品已存在！</span>");
                                } else {
                                    $("input[name=productName]").removeClass("Validform_error");
                                    $("input[name=productName]").parent().parent().find("div[class=col-2]").html("");
                                }
                            }
                        });
                        return false;
                    }
                }
            });
        </script>
    #end
    #@validateDiv("col-2")#end
#end


#@elementItem()
    #@colLabel()<span class="c-red">*</span>产品代号：#end
    #@formControlDiv("col-3")
        #tinyInput(
            "text" "productCode" ""{"placeholder":"请输入产品代号","datatype":"*","nullmsg":"代号不能为空！","id":
            "productCode","class":"input-text"})
        <script>
            $("input[name=productCode]").on("blur", function () {
                var pName = $(this).val();
                if (pName) {
                    $.ajax({
                        url: "${TINY_CONTEXT_PATH+adminPath}/product/judgeProductName",
                        type: "POST",
                        data: {productCode: pName},
                        success: function (data) {
                            if (data.status == "y") {
                                $("input[name=productCode]").addClass("Validform_error");
                                $("input[name=productCode]").parent().parent().find("div[class=col-2]").html("<span class='Validform_checktip Validform_wrong'>该代号已存在！</span>");
                            } else {
                                $("input[name=productCode]").removeClass("Validform_error");
                                $("input[name=productCode]").parent().parent().find("div[class=col-2]").html("");
                            }
                        }
                    });
                    return false;
                }
            });
        </script>
    #end
    #@validateDiv("col-2")#end
#end


#@elementItem()
    #@colLabel()<span class="c-red">*</span>产品负责人：#end
    #@formControlDiv("col-3")
        #@Tselect2F()
            #@Tselect2Body("productOwner" "" {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项
            #end
            <script>
                ajaxRead("${sid}", "productOwner", "orgUserId", "orgUserRealName", "/org/user/userList");
            </script>
            #@Tselect2Fix()
                    #set(m=menuManager.getMenu("organizationAddUser"))
                    #if(m)
                        <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}" class="r">增加</a>
                    #end
                    #set(m=menuManager.getMenu("organizationUser"))
                    #if(m)
                        <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}">全部</a>
                    #end
            #end
        #end

    #end
    #@validateDiv("col-2")#end
#end


#@elementItem()
    #@colLabel()测试负责人：#end
    #@formControlDiv("col-3")
        #@Tselect2F()
            #@Tselect2Body(
                "productQualityManager" "" {"class":"input-text select2","url":"/org/user/userList",
                "ajaxType":"orguser","data":""}) ##,"multiple":"multiple"加上为多选项
            #end
            <script>
                ajaxRead("${sid}", "productQualityManager", "orgUserId", "orgUserRealName", "/org/user/userList");
            </script>

            #@Tselect2Fix()
                #set(m=menuManager.getMenu("organizationAddUser"))
                #if(m)
                    <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}" class="r">增加</a>
                #end
                #set(m=menuManager.getMenu("organizationUser"))
                #if(m)
                    <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}">全部</a>
                #end
            #end
        #end

    #end
    #@validateDiv("col-2")#end
#end
#@elementItem()
    #@colLabel()发布负责人：#end
    #@formControlDiv("col-3")
        #@Tselect2F()
            #@Tselect2Body(
                "productDeliveryManager" "" {"class":"input-text select2 ","url":"/org/user/userList",
                "ajaxType":"orguser","data":""}) ##,"multiple":"multiple"加上为多选项
            #end
            <script>
                ajaxRead("${sid}", "productDeliveryManager", "orgUserId", "orgUserRealName", "/org/user/userList");
            </script>

            #@Tselect2Fix()
                #set(m=menuManager.getMenu("organizationAddUser"))
                #if(m)
                    <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}" class="r">增加</a>
                #end
                #set(m=menuManager.getMenu("organizationUser"))
                #if(m)
                    <a href="${TINY_CONTEXT_PATH+adminPath}${m.href}">全部</a>
                #end
            #end
        #end

    #end
    #@validateDiv("col-2")#end
#end
#@elementItem()
    #@colLabel()产品描述：#end
    #@formControlDiv("col-8")
        #@Teditor("productDesc" "productDesc" {"initialFrameHeight":"200" ,"placeholder":"说点什么...最少输入10个字符",
            "datatype":
            "*0-500"})#end
    #end
    #@validateDiv("col-2")#end
#end

#@elementItem()
    #@colLabel()<span class="c-red">*</span>访问控制：#end
    #@skinMinimal("col-8")

        #@Tradioes("acl" "1" {"onclick":"setWhite(this.value)"})
            #foreach(source:getDict("accessControl"))
                <div>#@Tradio(source?.value)${source?.text}#end</div>
            #end
        #end
    #end
    #@validateDiv("col-2")#end
#end
#@elementItem(elementId="whitelistBox" eleItemClass="hidden")
    #@colLabel()<span class="c-red">*</span>分组白名单：#end
    #@skinMinimal("col-8")
        #@Tcheckboxes("productWhiteList" "")
            #foreach(role : UserUtils.getAllRoleList())
                #@Tcheckbox(role?.orgRoleId)${role?.orgRoleName}#end
            #end
        #end

    #end
    #@validateDiv("col-2")#end
#end
</div>
#@elementItem()
    <div class="col-12">
        <div class="col-5">

        </div>
        <div class="col-1">
            <button style="float: left" type="submit" id="submit" class="commitBtn">保存</button>
        </div>
        <div class="col-1">
            #@aExtendButton("btn-sm backBtn" "javascript:history.go(-1)")返回#end
        </div>
        <div class="col-5"></div>
    </div>
#end
#end



    <script type="text/javascript">
        function setWhite(acl) {
            acl == '2' ? $('#whitelistBox').removeClass('hidden') : $('#whitelistBox').addClass('hidden');
        }
    </script>


    <script type="text/javascript">

        $(function () {
            $("form[name=thisform").Validform({
                tiptype: 2
            });
        });
    </script>