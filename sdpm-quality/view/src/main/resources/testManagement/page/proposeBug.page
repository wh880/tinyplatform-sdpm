#import("/org/tinygroup/button/components/button_common.component")
#import("/org/tinygroup/button/components/button.component")
#import("/org/tinygroup/table/components/table.component")
#!set(activeTitle="测试管理",activeMenuId=currentPageId)
<style>
    .select_boxes{margin-top:0}
</style>


#set(name="qualityBug")
#@div()
#@tabWithInit("tab_demo" "optionsBox")
	#@div(divClass="dropdownBox")
		#include("/testManagement/page/dropdownMenu.page")
	#end
	#@tabHead()
		#include("/testManagement/page/Tab.page")
	#end

	#@tabBodyCol("ptop-5")
##operationbar start1
#end
	#@tinyForm("thisform" TINY_CONTEXT_PATH+adminPath+"/quality/bug/save?bugConfirmed=0" "post" {"class":"test","enctype":"multipart/form-data"})
	#hiddenInput(hiddenInputName="bugId" hiddenInputValue=bug?.bugId)
	#hiddenInput(hiddenInputName="bugFromCase" hiddenInputValue=caseId)
	<div style="width:100%">
    	<div class="infoContent">
    		<p class="titleName">提Bug</p>
			#@elementItem()
				#@colLabel()产品模块：#end
				#@formControlDiv("col-8")
					#@div(divClass="col-5")
					 #@Tselect2F()
	                   		 #@Tselect2Body("productId" bug?.productId?:qualityProductId {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项
								 #foreach(product : ProductUtils.getAllProductListByUser())
								#if(product?.deleted==0)
	                       		 <option value="${product?.productId}">${product?.productName}</option>
								#end
	                       	 #end
	                    	#end
							<script type="text/javascript">
								$("#${sid}").on("change",function(){
									var pId = $("#${sid}  option:selected").val();
                                    var pjId = $("select[name=projectId]  option:selected").val();
									if(pId>0){
										ajaxRead("${sid}","moduleId","moduleId","moduleName","/quality/bug/ajax/module?moduleRoot="+pId,${bug?.moduleId?:0},"module");
										ajaxRead("${sid}","projectId","projectId","projectName","/quality/bug/ajax/project?productId="+pId,${bug?.projectId?:0});
									}
									if(pId>0&&pjId>0) {
                                        ajaxRead("${sid}","bugOpenedBuild","buildId","buildName","/quality/bug/ajax/build?buildProduct="+pId+"&buildProject="+pjId,${bug?.buildId?:0},"build");
									}
								})
							</script>
	                    	#@Tselect2Fix()
	                    	<a href="${TINY_CONTEXT_PATH+adminPath}/product/addproduct/addition" class="r ">增加</a>
	                    	<a href="${TINY_CONTEXT_PATH+adminPath}/product/allproduct/addition">全部</a>#end
                	  #end
					#end
					#@div(divClass="col-0")&nbsp;&nbsp#end
					#@div(divClass="col-3")
					 #@Tselect2F()
	                   		 #@Tselect2Body("moduleId" "" {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项
									<option value="0">/</option>
	                    	#end
							<script type="text/javascript">
								$("#${sid}").on("change",function(){
									var mId = $("#${sid}  option:selected").val();
									var pId = $("select[name=productId]  option:selected").val();
									if(mId>=0){
										ajaxRead("${sid}","storyId","storyId","storyTitle","/quality/bug/ajax/story?productId="+pId+"&moduleId="+mId,${bug?.storyId?:0});
									}
								})
							</script>
                	  #end

					#end

				#end
			#end
			#@elementItem()
				#@colLabel()所属项目：#end
				#@formControlDiv("col-8")
					#@div(divClass="col-5")
					 #@Tselect2F()
	                   		 #@Tselect2Body("projectId" bug?.projectId?:(projectList.size()>0?projectList.get(0).projectId:0) {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项

							#end
			<script type="text/javascript">
				$("#${sid}").on("change",function(){
					var pjId = $("#${sid}  option:selected").val();
                    var pId = $("select[name=productId]  option:selected").val();
                    if(pjId>0){
                        ajaxRead("${sid}","taskId","taskId","taskName","/quality/bug/ajax/task?taskProject="+pjId,${bug?.taskId?:0});
                        ajaxRead("${sid}","bugAssignedTo","orgUserId","orgUserRealName","/quality/version/ajax/user?projectId="+pjId,"${bug?.bugAssignedTo?:0}");
                    }
					if(pId>0&&pjId>0) {
						ajaxRead("${sid}","bugOpenedBuild","buildId","buildName","/quality/bug/ajax/build?buildProduct="+pId+"&buildProject="+pjId,${bug?.buildId?:0},"build");
					}
				})
			</script>
	                    	#@Tselect2Fix()
	                    	<a href="${TINY_CONTEXT_PATH+adminPath}/project/form" class="r ">增加</a>
	                    	<a href="${TINY_CONTEXT_PATH+adminPath}/project/list">全部</a>
	                    	#end
                	  #end
                	 #end
				#end
				#@validateDiv("col-2")#end
			#end
			#@elementItem()
				#@colLabel()<span class="c-red">*</span>影响版本：#end
				#@formControlDiv("col-8")
					#@div(divClass="col-5")
					 #@Tselect2F()
							#@Tselect2Body("bugOpenedBuild" bug?.bugOpenedBuild {"class":"input-text select2","multiple":"multiple"}) ##,"multiple":"multiple"加上为多选项
	                    	#end
						 #@Tselect2Fix()
                             <a href="${TINY_CONTEXT_PATH+adminPath}/project/build/add" class="r ">增加</a>
                             <a href="${TINY_CONTEXT_PATH+adminPath}/project/build/index">全部</a>
						 #end
					 #end
                	 #end
				#end
				#@validateDiv("col-2")#end
			#end

			#@elementItem()
				#@colLabel()当前指派：#end
						#@formControlDiv("col-8")
							#@div(divClass="col-5")
							 #@Tselect2F()
								 #@Tselect2Body("bugAssignedTo" bug?.bugAssignedTo {"class":
									 "input-text select2"}) ##,"multiple":"multiple"加上为多选项

	                    	#end
	                       #@Tselect2Fix()<a href="${TINY_CONTEXT_PATH+adminPath}/org/user/form" class="r ">增加</a>#end
                	 		#end
                	  #end
							#@validateDiv("col-2")#end
				#end
				#@validateDiv("col-2")#end
			#end
			#@elementItem()

				#@colLabel()<span class="c-red">*</span>Bug标题/<span class="c-red">*</span>优先级：#end
				#@formControlDiv("col-8")
				#@div(divClass="col-5")

					#tinyInput("text" "bugTitle" bug?.bugTitle {"placeholder":"请输入bug名称","datatype":"*","nullmsg":"bug名称不能为空！","id":"版本","class":"input-text"})
				#end
				#@div(divClass="col-0")&nbsp&nbsp#end
                	 #@div(divClass="col-3")

					#@tinySelect("priority" bug?.priority {"placeholder":"请选择优先级","datatype":"*","nullmsg":"优先级不能为空！","class":"select2"})
					#for(pri : getDict("bugPriority"))
							#@tinyOptionItem(pri.value)${pri.text}#end
					#end
					#end
				#end
				#end
				#@validateDiv("col-2")#end
			#end
			#@elementItem()
				#@colLabel()重现步骤：#end
				#@formControlDiv("col-8")
					#@Teditor("bugSteps" "bugSteps" {"initialFrameHeight":"150"})${bugStep?:bug?.bugSteps}#end
				#end
				#@validateDiv("col-2")#end
			#end
			#@elementItem()
				#@colLabel()相关需求：#end
				#@formControlDiv("col-8")
					#@div(divClass="col-5")
							 #@Tselect2F()
	                   		 #@Tselect2Body("storyId" "" {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项

	                    	#end
	                      	#@Tselect2Fix()
	                      	<a href="${TINY_CONTEXT_PATH+adminPath}/product/story/addstory" class="r ">增加</a>
	                      	<a href="${TINY_CONTEXT_PATH+adminPath}/product/story?choose=1">全部</a>#end
                			#end
					#end
				#end
			#end
			#@elementItem()
				#@colLabel()相关任务：#end
				#@formControlDiv("col-8")
				#@div(divClass="col-5")
					 #@Tselect2F()
							#@Tselect2Body("taskId" bug?.taskId {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项

	                    	#end
	                    	#@Tselect2Fix()
	                    	<a href="${TINY_CONTEXT_PATH+adminPath}/project/task/form" class="r ">增加</a>
	                    	<a href="${TINY_CONTEXT_PATH+adminPath}/project/task/index">全部</a>#end
                	  #end
                #end
				#end
				#@validateDiv("col-2")#end
			#end
			#@elementItem()

				#@colLabel()类型/<span class="c-red">*</span>严重程度：#end
				#@formControlDiv("col-8")
					#@div(divClass="col-5")
					#@tinySelect("bugType" bug?.bugType {"class":"select2"})
					#for(type : getDict("bugType"))
							#@tinyOptionItem(type.value)${type.text}#end
					#end
					#end
					#end
					#@div(divClass="col-0")&nbsp&nbsp#end
					#@div(divClass="col-3")
					 #@Tselect2F()
	                   		 #@Tselect2Body("bugSeverity" bug?.bugSeverity {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项
	                        #for(se : getDict("bugSeverity"))
                                 #@tinyOptionItem(se.value)${se.text}#end
                            #end
	                    	#end
	                    	###@Tselect2Fix()<a href="http://www.baidu.com" class="r ">增加</a><a href="#">全部</a>#end
                	  #end
					#end
				#end
			#end
			#@elementItem()
				#@colLabel()系统/浏览器：#end
				#@formControlDiv("col-8")
					#@div(divClass="col-5")
					#@tinySelect("operatingSystem" bug?.operatingSystem {"class":"select2"})
					#for(os : getDict("bugOS"))
							#@tinyOptionItem(os.value)${os.text}#end
                    #end
					#end
					#end
					#@div(divClass="col-0")&nbsp&nbsp#end
					#@div(divClass="col-3")
					#@tinySelect("browser" bug?.browser {"class":"select2"})
					#for(bro : getDict("bugBrowser"))
							#@tinyOptionItem(bro.value)${bro.text}#end
					#end
					#end
					#end
				#end
			#end
			#@elementItem()
				#@colLabel()抄送给：#end
				#@formControlDiv("col-8")
					#@div(divClass="col-5")
					 #@Tselect2F()
	                   		 #@Tselect2Body("bugMailto" bug?.bugMailto {"class":"input-text select2","multiple":"multiple"}) ##,"multiple":"multiple"加上为多选项
								#foreach(user : userList)
								<option value="${user?.orgUserId}">${user?.orgUserRealName}</option>
								#end
	                    	#end
						 #@Tselect2Fix()<a href="${TINY_CONTEXT_PATH+adminPath}/org/user/form" class="r ">增加</a>#end
                	  #end
                	 #end
				#end
				#@validateDiv("col-2")#end
			#end

			#@elementItem()
				#@colLabel()关键词：#end
				#@formControlDiv("col-8")
				#@div(divClass="col-5")
					#tinyInput("text" "bugKeywords" bug?.bugKeywords {"datatype":"","id":"关键词","class":"input-text"})
				#end
				#end
				#@validateDiv("col-2")#end
			#end
			#@elementItem()
				#@colLabel()附件：#end
				#@formControlDiv("col-8")
					#include("/testManagement/page/fileupload.page")
				#end
				#@validateDiv("col-2")#end
			#end
			#@elementItem()
       		 	<div class="col-12">
            	<div class="col-5">
                <button style="float: right" type="submit" id="submit" class="commitBtn">保存</button>
            	</div>
            	<div class="col-1"></div>
            	<div class="col-1">

                #@aExtendButton("btn-sm backBtn" "javascript:history.go(-1)")返回#end
           		 </div>
            	<div class="col-5"></div>
        		</div>
			#end
			<br>
		#end
		</div>
	</div>
	#end
#end

<script type="text/javascript">
    $(function () {
        $("form[name=thisform").Validform({
            tiptype: 2
        });
    });

	function ajaxRead(id,toName,opKey,opvalue,url,value,isBuild){
    		var selectCheck = "select[name="+toName+"]";
    		$(selectCheck).each(function(){
    			var sele = $(this);
    			var s;
    			$.ajax({
    				type: "POST",
    				url: "${TINY_CONTEXT_PATH+adminPath}"+url,
    				data: $(this).attr('data'),
    				dataType:"json",
    				success: function(data){
    					sele.empty();
                        var em;
    					if("build"==(isBuild)){
    					 em = "<option value='0' selected  >trunk</option>";
    					}else if("module"==isBuild){
    					 em = "<option value='0' selected  >/</option>";
    					}
    					sele.append(em);
    					for(var i=0,l=data.length;i<l;i++){
    						var em = "<option value='"+data[i][opKey]+"' >"+ data[i][opvalue] +"</option>";
    						sele.append(em);

    					}
    					if(value!=null) {
    						sele.val(value).trigger("change");
    					}else {
    						sele.val(data[0][opKey]).trigger("change");
    					}
    				},
    				error: function(res){
//    					alert("失败");
    				}
    			});


    		});

    	}
</script>

