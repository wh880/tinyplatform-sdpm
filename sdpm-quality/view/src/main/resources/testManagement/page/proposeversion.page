#import("/org/tinygroup/button/components/button_common.component")
#import("/org/tinygroup/button/components/button.component")
#!set(activeTitle="测试管理",activeMenuId=currentPageId)
<style>
    .select_boxes{margin-top:0}
</style>
<script type="text/javascript">
	function ajaxRead(id,toName,opKey,opvalue,url,value,isBuild){
    		var selectCheck = "select[name="+toName+"]";
    		$(selectCheck).each(function(){
    			var sele = $(this);
    			var s;
    			$.ajax({
    				type: "POST",
    				url: "${TINY_CONTEXT_PATH+adminPath}"+url,
    				data: $(this).attr('data'),
    				dataType:"json",
    				success: function(data){
    					sele.empty();
                        var em;
                        if("build"==(isBuild)){
                            em = "<option value='0' selected  >trunk</option>";
                        }else if("module"==isBuild){
                            em = "<option value='0' selected  >/</option>";
                        }
    					sele.append(em);
    					for(var i=0,l=data.length;i<l;i++){
    						var em = "<option value='"+data[i][opKey]+"' >"+ data[i][opvalue] +"</option>";
    						sele.append(em);

    					}

    					if(value!=null) {
    						sele.val(value).trigger("change");
    					}else {
    						sele.val(data[0][opKey]).trigger("change");
    					}


    				},
    				error: function(res){
//    					alert("失败");
    				}
    			});


    		});

    	}
</script>

#set(name="qualityVersion")
#@div()
#@tabWithInit("tab_demo" "optionsBox")
    #@div(divClass="dropdownBox")
        #include("/testManagement/page/dropdownMenu.page")
    #end
    #@tabHead()
        #include("/testManagement/page/Tab.page")
    #end

    #@tabBodyCol("ptop-5")
##operationbar start1

#end
    #@tinyForm("thisform" "" "post" {"class":"test"})
    #hiddenInput(hiddenInputName="testversionId" hiddenInputValue=testTask?.testversionId)
    #hiddenInput(hiddenInputName="productId" hiddenInputValue=qualityProductId)
    <div style="width:100%">
    	<div class="infoContent">
    		<p class="titleName">提交测试</p>
        #@elementItem()
            #@colLabel()<span class="c-red">*</span>所属项目：#end
            #@formControlDiv("col-8")
					#@div(divClass="col-5")
					 #@Tselect2F()
					 <script type="text/javascript">
					 $(function(){
                         ajaxRead("${sid}", "projectId", "projectId", "projectName", "/quality/bug/ajax/project?productId=${qualityProductId}", "${testTask?.projectId?:(projectId?:0)}");
					    $("#${sid}").on("change",function(){
                             var pId = $("#${sid}  option:selected").val();
                            if(pId&&pId>0){
                                ajaxRead("${sid}", "buildName", "buildId", "buildName", "/quality/version/ajax/build?buildProject=" + pId + "&buildProduct=${qualityProductId?:0}", "${testTask?.buildName?:(buildId?:0)}","build");
                                 ajaxRead("${sid}","testtaskOwner","orgUserId","orgUserRealName","/quality/version/ajax/user?projectId="+pId,"${testTask?.testtaskOwner?:0}");
                            }
                        });
					 })
                     </script>
                         #@Tselect2Body(
                             "projectId" testTask?.projectId?:(projectId?:0) {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项

	                    	#end
                         #@Tselect2Fix()
                             #@hasMenu("project-op-add")
                                 <a href="${TINY_CONTEXT_PATH+adminPath}/project/form" class="r">增加</a>
                             #end
                             #@hasMenu("project-op-all")
                                 <a href="${TINY_CONTEXT_PATH+adminPath}/project/list">全部</a>
                             #end
                         #end
                	  #end
                	 #end
				#end
        #end
        #@elementItem()
            #@colLabel()<span class="c-red">*</span>版本：#end
            #@formControlDiv("col-8")
					#@div(divClass="col-5")
					 #@Tselect2F()
                         #@Tselect2Body("buildName" testTask?.buildName?:buildId {"class":
                             "input-text select2"}) ##,"multiple":"multiple"加上为多选项

	                    	#end
                         #@Tselect2Fix()
                             #@hasMenu("pro-version-add")
                                 <a href="${TINY_CONTEXT_PATH+adminPath}/project/build/edit" class="r ">增加</a>
                             #end
                             #@hasMenu("version")
                                 <a href="${TINY_CONTEXT_PATH+adminPath}/project/build/index">全部</a>
                             #end
                         #end
                	  #end
                	 #end
				#end
            #@validateDiv("col-2")#end
        #end
        #@elementItem()
            #@colLabel()负责人：#end
            #@formControlDiv("col-8")
					#@div(divClass="col-5")
					 #@Tselect2F()
	                   		 #@Tselect2Body("testtaskOwner" testTask?.testtaskOwner {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项

	                    	#end
                         #@Tselect2Fix()
                             #@hasMenu("organizationAddUser")
                                 <a href="${TINY_CONTEXT_PATH}/a/org/user/form">增加</a>
                             #end
                             #@hasMenu("organizationUser")
                                 <a href="${TINY_CONTEXT_PATH}/a/org/user/list" class="r">全部</a>
                             #end
                         #end
                	  #end
                	 #end
				#end
            #@validateDiv("col-2")#end
        #end

        #@elementItem()
            #@colLabel()优先级：#end
            #@formControlDiv("col-8")
                    #@div(divClass="col-5")
					 #@Tselect2F()
	                   		 #@Tselect2Body("priority" testTask?.priority {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项
                                #foreach(pri : getDict("versionPriority"))
                                    <option value="${pri?.value}">${pri?.text}</option>
                                #end
	                    	#end                
                	 #end
                #end
            #end
            #@validateDiv("col-2")#end
        #end

        #@elementItem()
            #@colLabel()<span class="c-red">*</span>开始日期：#end
            #@formControlDiv("col-8")
            	#@div(divClass="col-5")
                #@tinyDateInput("testtaskBegin" formatDate(testTask?.testtaskBegin,"yyyy-MM-dd") "yyyy-MM-dd" {"datatype":"*","nullmsg":"日期不能为空","placeholder":""})#end
           		#end
            #end
            #@validateDiv("col-2")#end
        #end
        #@elementItem()
            #@colLabel()<span class="c-red">*</span>结束日期：#end
            #@formControlDiv("col-8")
                #@div(divClass="col-5")
                #@tinyDateInput("testtaskEnd" formatDate(testTask?.testtaskEnd,"yyyy-MM-dd") "yyyy-MM-dd" {"datatype":"*","nullmsg":"日期不能为空","placeholder":""})#end
           		#end
            #end
            #@validateDiv("col-2")#end
        #end
        #@elementItem()
            #@colLabel()当前状态：#end
            #@formControlDiv("col-8")
                #@div(divClass="col-5")
						#@Tselect2F()
	                   		 #@Tselect2Body("testtaskStatus" testTask?.testtaskStatus {"class":"input-text select2"}) ##,"multiple":"multiple"加上为多选项
	                        #foreach(status : getDict("versionStatus"))
                                <option value="${status?.value}">${status?.text}</option>
                            #end
	                    	#end                
               			#end
                #end
            #end
            #@validateDiv("col-2")#end
        #end
        #@elementItem()
            #@colLabel()<span class="c-red">*</span>任务名称：#end
            #@formControlDiv("col-8")
            	#@div(divClass="col-5")
                	#tinyInput("text" "testtaskTitle" testTask?.testtaskTitle {"datatype":"*","id":"关键词","class":"input-text"})
                #end
            #end
            #@validateDiv("col-2")#end
        #end
        #@elementItem()
            #@colLabel()描述：#end
            #@formControlDiv("col-8")
                #@Teditor("content" "testtaskDesc" {"initialFrameHeight":"150"})#end
            #end
            #@validateDiv("col-2")#end
        #end

        #@elementItem()
        <div class="col-12">
            <div class="col-5">

            </div>
            <div class="col-1">
                <button style="float: left" type="submit" id="submit" class="commitBtn">保存</button>
            </div>
            <div class="col-1">
            #@aExtendButton("btn-sm backBtn" "javascript:history.go(-1)")返回#end
            </div>
            <div class="col-5"></div>
        </div>
    	#end
    </div>
    </div>
    #end
<script type="text/javascript">
    $(function(){
        $(".selectList").each(function(){
            var url = "#link('/getDist.html')";
            var areaJson;
            var temp_html;
            var oProvince = $(this).find(".province");
            var oCity = $(this).find(".city");
            var oDistrict = $(this).find(".district");
            //初始化省
            var province = function(){
                $.each(areaJson,function(i,province){
                    temp_html+="<option value='"+province.p+"'>"+province.p+"</option>";
                });
                oProvince.html(temp_html);
                city();
            };
            //赋值市
            var city = function(){
                temp_html = "";
                var n = oProvince.get(0).selectedIndex;
                $.each(areaJson[n].c,function(i,city){
                    temp_html+="<option value='"+city.ct+"'>"+city.ct+"</option>";
                });
                oCity.html(temp_html);
                district();
            };
            //赋值县
            var district = function(){
                temp_html = "";
                var m = oProvince.get(0).selectedIndex;
                var n = oCity.get(0).selectedIndex;
                if(typeof(areaJson[m].c[n].d) == "undefined"){
                    oDistrict.css("display","none");
                }else{
                    oDistrict.css("display","inline");
                    $.each(areaJson[m].c[n].d,function(i,district){
                        temp_html+="<option value='"+district.dt+"'>"+district.dt+"</option>";
                    });
                    oDistrict.html(temp_html);
                };
            };
            //选择省改变市
            oProvince.change(function(){
                city();
            });
            //选择市改变县
            oCity.change(function(){
                district();
            });
            //获取json数据
            $.getJSON(url,function(data){
                areaJson = data;
                province();
            });
        });
    });
    $(function(){

        $("form[name=thisform").attr("action",'#link(adminPath+"/quality/version/save")');
        $("form[name=thisform").Validform({
            tiptype:2,
            usePlugin:{
                //datepicker:{},//日期控件校验;
                passwordstrength:{
                    minLen:6,//设置密码长度最小值，默认为0;
                    maxLen:18,//设置密码长度最大值，默认为30;
                    trigger:function(obj,error){
                        //该表单元素的keyup和blur事件会触发该函数的执行;
                        //obj:当前表单元素jquery对象;
                        //error:所设密码是否符合验证要求，验证不能通过error为true，验证通过则为false;
                        //console.log(error);
                        if(error){
                            obj.parent().find(".Validform_checktip").show();
                            obj.parent().find(".passwordStrength").hide();
                        }else{
                            obj.parent().find(".passwordStrength").show();
                        }
                    }
                }
            },
            ajaxPost:true,
            beforeCheck:function(curform){
                //在表单提交执行验证之前执行的函数，curform参数是当前表单对象。
                //这里明确return false的话将不会继续执行验证操作;
            },
            beforeSubmit:function(curform){
                //在验证成功后，表单提交前执行的函数，curform参数是当前表单对象。
                //这里明确return false的话表单将不会提交;
            },
            callback:function(data){
                if(data.status=="y"){
                    window.location.href="${TINY_CONTEXT_PATH+adminPath}/quality/version?status=tvernotest";
                }
                //返回数据data是json对象，{"info":"demo info","status":"y"}
                //info: 输出提示信息;
                //status: 返回提交数据的状态,是否提交成功。如可以用"y"表示提交成功，"n"表示提交失败，在Validform_post.html文件返回数据里自定字符，主要用在callback函数里根据该值执行相应的回调操作;
                //你也可以在Validform_post.html文件返回更多信息在这里获取，进行相应操作；
                //ajax遇到服务端错误时也会执行回调，这时的data是{ status:**, statusText:**, readyState:**, responseText:** }；

                //这里执行回调操作;
                //注意：如果不是ajax方式提交表单，传入callback，这时data参数是当前表单对象，回调函数会在表单验证全部通过后执行，然后判断是否提交表单，如果callback里明确return false，则表单不会提交，如果return true或没有return，则会提交表单。
            }
        });
    });
</script>

        #end
#end

